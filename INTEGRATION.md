# papilio_hdmi Integration Guide

This library provides HDMI video output control for the Papilio Arcade Board via Wishbone-over-SPI.

## Quick Start

### Firmware Integration

**Add to `platformio.ini`:**
```ini
lib_deps = 
    https://github.com/GadgetFactory/papilio_hdmi.git#main
```

**Basic Usage:**
```cpp
#include <HDMIController.h>

SPIClass *fpgaSPI = nullptr;
HDMIController *hdmi = nullptr;

void setup() {
    // Initialize SPI
    fpgaSPI = new SPIClass(HSPI);
    fpgaSPI->begin(12, 9, 11, 10); // CLK, MISO, MOSI, CS
    
    // Initialize HDMI (make persistent)
    hdmi = new HDMIController(fpgaSPI, 10, 12, 11, 9);
    hdmi->begin();
    hdmi->setVideoPattern(1); // 0=color bar, 1=net grid, 2=gray, 3=single color
}

void loop() {
    // Change pattern
    hdmi->setVideoPattern(0);
    delay(2000);
}
```

### Gateware Integration

**Wishbone Address:** 0x10-0x1F (Slave 1 recommended)

**Top-Level Module Ports:**
```verilog
module top (
    // ... existing ports ...
    
    // HDMI TMDS differential outputs
    output wire O_tmds_clk_p,
    output wire O_tmds_clk_n,
    output wire [2:0] O_tmds_data_p,  // {red, green, blue}
    output wire [2:0] O_tmds_data_n
);
```

**Wishbone Slave Signals:**
```verilog
// Add to your top module
wire [7:0] s1_wb_adr;
wire [7:0] s1_wb_dat_o;
wire [7:0] s1_wb_dat_i;
wire s1_wb_cyc;
wire s1_wb_stb;
wire s1_wb_we;
wire s1_wb_ack;
```

**Module Instantiation:**
```verilog
wb_video_ctrl u_wb_video_ctrl (
    .clk(clk_27mhz),
    .rst_n(rst_n),
    .wb_adr_i(s1_wb_adr),
    .wb_dat_i(s1_wb_dat_o),
    .wb_dat_o(s1_wb_dat_i),
    .wb_cyc_i(s1_wb_cyc),
    .wb_stb_i(s1_wb_stb),
    .wb_we_i(s1_wb_we),
    .wb_ack_o(s1_wb_ack),
    .O_tmds_clk_p(O_tmds_clk_p),
    .O_tmds_clk_n(O_tmds_clk_n),
    .O_tmds_data_p(O_tmds_data_p),
    .O_tmds_data_n(O_tmds_data_n)
);
```

### Pin Constraints (pins.cst)

**For GW2A-18C (Papilio Arcade Board):**
```
IO_LOC "O_tmds_clk_p" P6,T6;
IO_PORT "O_tmds_clk_p" IO_TYPE=LVCMOS18D PULL_MODE=NONE DRIVE=8;
IO_LOC "O_tmds_data_p[0]" M6,T8;
IO_PORT "O_tmds_data_p[0]" IO_TYPE=LVCMOS18D PULL_MODE=NONE DRIVE=8;
IO_LOC "O_tmds_data_p[1]" T11,P11;
IO_PORT "O_tmds_data_p[1]" IO_TYPE=LVCMOS18D PULL_MODE=NONE DRIVE=8;
IO_LOC "O_tmds_data_p[2]" T12,R11;
IO_PORT "O_tmds_data_p[2]" IO_TYPE=LVCMOS18D PULL_MODE=NONE DRIVE=8;
```

**Note:** 
- Uses LVCMOS18D (1.8V differential) - verify your FPGA bank voltage
- First pin is positive (_p), second is negative (_n)
- Adjust pin numbers for your specific board

### Required Gateware Files

Add these files to your `.gprj` project file:

**Core modules:**
```xml
<File path="path/to/papilio_hdmi/gateware/src/wb_video_ctrl.v" type="file.verilog" enable="1"/>
<File path="path/to/papilio_hdmi/gateware/src/video_top_wb.v" type="file.verilog" enable="1"/>
<File path="path/to/papilio_hdmi/gateware/src/testpattern.v" type="file.verilog" enable="1"/>
<File path="path/to/papilio_hdmi/gateware/src/TMDS_rPLL.v" type="file.verilog" enable="1"/>
```

**DVI transmitter (Required - Gowin IP core):**
```xml
<File path="path/to/papilio_hdmi/gateware/src/dvi_tx/dvi_tx.v" type="file.verilog" enable="1"/>
```

**Note:** The `dvi_tx.v` is an encrypted Gowin IP core and must be included for proper HDMI output.

## Video Patterns

The library supports 4 test patterns (I_mode in testpattern.v):

| Pattern | Name | Description |
|---------|------|-------------|
| 0 | color bar | 8-color vertical bars |
| 1 | net grid | 32-pixel grid pattern |
| 2 | gray | Grayscale gradient |
| 3 | single color | Solid color (configurable) |

## Video Timing

Default: **720p @ 60Hz (1280x720)**
- Pixel clock: 74.25 MHz (generated by TMDS_rPLL from 27 MHz input)
- Horizontal: 1650 total, 1280 active
- Vertical: 750 total, 720 active

## Architecture Details

**Signal Flow:**
```
ESP32-S3 (SPI) → Wishbone Bridge → wb_video_ctrl → video_top_wb → DVI_TX_Top → HDMI
                                         ↓
                                    TMDS_rPLL (74.25 MHz)
                                         ↓
                                   testpattern → TMDS encoder
```

**Clock Domains:**
- System clock: 27 MHz (FPGA input)
- Serial clock: 371.25 MHz (from TMDS_rPLL, 5x pixel clock)
- Pixel clock: 74.25 MHz (from CLKDIV, serial/5)

## Hardware Requirements

- **FPGA:** Gowin GW2A-18C or compatible
- **I/O Bank:** 1.8V for LVCMOS18D differential pairs
- **Resources:** ~3000 LUTs, 1 PLL, 1 CLKDIV
- **External:** HDMI connector with proper differential routing

## Troubleshooting

**No HDMI output:**
- Verify DVI IP core (`dvi_tx.v`) is included in project
- Check pin constraints match top-level port names exactly
- Ensure LVCMOS18D is supported on your FPGA I/O bank
- Verify 27 MHz clock is present and stable

**Pattern doesn't change:**
- Check Wishbone address (should be 0x10)
- Verify SPI communication is working (test with RGB LED)
- Monitor serial output for debug messages

**Display shows "no signal":**
- Confirm pixel clock is generated (74.25 MHz)
- Check HDMI cable and display compatibility
- Verify differential pairs are routed correctly (p/n not swapped)

## Reference Implementation

See working example: [papilio_arcade_template](https://github.com/GadgetFactory/papilio_arcade_template)

Key files:
- `src/papliio_arcade_template.ino` - Firmware integration
- `src/gateware/top.v` - Gateware instantiation
- `src/gateware/pins.cst` - Pin constraints

## API Reference

### HDMIController Class

**Constructor:**
```cpp
HDMIController(SPIClass* spi, uint8_t csPin, uint8_t spiClk, uint8_t spiMosi, uint8_t spiMiso);
```

**Methods:**
- `void begin()` - Initialize HDMI controller
- `void setVideoPattern(uint8_t pattern)` - Set test pattern (0-3)
- `uint8_t getVideoPattern()` - Read current pattern
- `uint8_t getVideoStatus()` - Read status register

**Register Map (Wishbone addresses relative to base 0x10):**
- `0x00` - Pattern mode (read/write)
- `0x01` - Version/status (read-only)

## License

[Include appropriate license information]

## Support

For issues and questions:
- GitHub Issues: https://github.com/GadgetFactory/papilio_hdmi/issues
- Forum: [forum link if available]
