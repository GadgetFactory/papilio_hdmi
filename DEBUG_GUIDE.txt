// Debugging Tips for RGB LED SPI Control

1. **Test with Simple Auto-Cycling (no SPI)**
   Replace the spi_rgb_led_top instantiation in top.v with:
   
   ```verilog
   rgb_led_test u_rgb_test (
       .clk(clk_27mhz),
       .rst_n(rst_n),
       .led_out(rgb_led)
   );
   ```
   
   This will cycle through 8 colors automatically every 2 seconds.
   If this works, the LED hardware is fine and the issue is in the SPI interface.

2. **Check ESP32 SPI Pins**
   Verify the pin mappings in your Arduino code match your hardware:
   - SPI_CLK, SPI_MOSI, SPI_MISO, SPI_CS pins
   - Make sure these connect to the correct FPGA pins (esp_clk, esp_mosi, esp_miso, esp_cs_n)

3. **Verify SPI Timing**
   The current SPI clock is set to 1MHz. Try reducing it:
   ```cpp
   SPISettings(100000, MSBFIRST, SPI_MODE0)  // 100kHz instead of 1MHz
   ```

4. **Check CS Polarity**
   The FPGA expects CS to be active-low (idle high).
   Verify: digitalWrite(SPI_CS, HIGH) when idle, LOW when transmitting

5. **Add Debug to Arduino Code**
   Add after each wishboneWrite:
   ```cpp
   Serial.print("Wrote addr=0x"); Serial.print(address, HEX);
   Serial.print(" data=0x"); Serial.println(data, HEX);
   delayMicroseconds(100); // Extra delay between transactions
   ```

6. **Verify FPGA is Receiving Data**
   The issue might be:
   - SPI clock domain crossing issues
   - CS timing (going low too early or high too late)
   - Data not being held stable long enough

7. **Try Longer Delays**
   In Arduino code, increase delays:
   ```cpp
   void setLEDColor(uint32_t color) {
       wishboneWrite(REG_LED0, color);
       delay(10);  // Increase from 1ms to 10ms
       wishboneWrite(REG_CTRL, 0x00000001);
       delay(100); // Increase to 100ms to allow LED update to complete
   }
   ```

8. **Check if Initialization Blocks SPI**
   The init_state check might be an issue. Try disabling power-on green:
   Comment out the initialization state machine in wb_rgb_led_ctrl.v
   and set led0_data to 24'h000000 (off) at reset.

9. **Verify WS2812B Timing**
   At 27MHz clock:
   - CYCLES_PER_BIT should be 33 (27MHz / 800kHz)
   - CYCLES_T0H should be 10 (0.4us * 27MHz)
   - CYCLES_T1H should be 21 (0.8us * 27MHz)
   
   Current values might be wrong due to integer division.

10. **Simple Loopback Test**
    Temporarily connect esp_miso directly to a test pin to verify
    SPI communication is happening:
    ```verilog
    assign test_pin = esp_mosi;  // Should toggle when ESP32 sends
    ```

RECOMMENDED FIRST STEP:
Try the rgb_led_test module first to confirm LED hardware works!
